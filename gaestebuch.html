<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GÄSTEBUCH</title>

  <style>
    :root{
      --bgA:#ff1f3a;
      --bgB:#e6003a;
      --bgC:#a80024;
    }

    *{ box-sizing:border-box; }
    html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:#fff;
      overflow-x:hidden;

      background:
        radial-gradient(1200px 700px at 20% 15%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(255,160,160,.16), transparent 55%),
        radial-gradient(900px 700px at 50% 95%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(135deg, var(--bgA), var(--bgB) 45%, var(--bgC));
    }

    /* ===== BACKGROUND STAGE (DARF NIE EVENTS FANGEN) ===== */
    .stage{
      position: fixed;
      inset: 0;
      z-index: -10;
      pointer-events: none; /* <- wichtigster Fix */
    }

    .glow{
      position: absolute;
      inset: -35%;
      filter: blur(45px);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), transparent 45%),
        radial-gradient(circle at 70% 25%, rgba(255,200,230,.16), transparent 48%),
        radial-gradient(circle at 50% 80%, rgba(255,255,255,.14), transparent 55%);
      animation: drift 10s ease-in-out infinite alternate;
    }
    @keyframes drift{
      from{ transform: translate3d(-1.2%, -1%, 0) scale(1); }
      to  { transform: translate3d( 1.2%,  1%, 0) scale(1.02); }
    }

    #sparkles{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }

    /* ===== LAYOUT ===== */
    .wrap{
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      position: relative;
      z-index: 10;
      padding-bottom: clamp(180px, 22vh, 340px); /* Platz unten für Silhouette/TV */
    }

    header{
      width: 100%;
      padding: 4px 16px 10px;
      display:flex;
      justify-content:center;
    }

    .menu{
      display:flex;
      gap: 26px;
      justify-content:center;
      align-items:center;
      padding: 18px 0;
      flex-wrap: wrap;
    }

    .sticker{
      position: relative;
      display:inline-block;
      padding: 8px 16px;

      background:#fff;
      color:#111;
      text-decoration:none;
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: .08em;
      font-size: 13px;
      line-height: 1;

      border: none;
      border-radius: 0;

      transform: rotate(var(--r)) skewX(var(--sk));
      box-shadow: 8px 8px 0 #000;
      transition: transform .15s ease, box-shadow .15s ease;
      user-select:none;
    }
    .sticker span{ display:inline-block; transform: skewX(calc(var(--sk) * -1)); }
    .sticker:hover{
      transform: rotate(var(--r)) skewX(var(--sk)) translateY(-3px);
      box-shadow: 12px 12px 0 #000;
    }
    .sticker:active{
      transform: rotate(var(--r)) skewX(var(--sk)) translateY(1px);
      box-shadow: 6px 6px 0 #000;
    }

    .sticker.s1{ --r:-3deg; --sk:-8deg; }
    .sticker.s2{ --r: 2deg; --sk:-7deg; }
    .sticker.s3{ --r:-2deg; --sk:-9deg; }
    .sticker.s4{ --r: 3deg; --sk:-6deg; }
    .sticker.s5{ --r:-2deg; --sk:-8deg; }

    .logo-area{
      width: 100%;
      display:flex;
      justify-content:center;
      padding: 24px 16px 0px;
    }
    .logo{
      max-width: min(520px, 86vw);
      height: auto;
      display:block;
      filter:
        drop-shadow(0 18px 0 rgba(0,0,0,.18))
        drop-shadow(0 28px 45px rgba(0,0,0,.22));
      transform: translateY(2px);
    }

    .logo-btn{
      position: relative;
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      display: inline-grid;
      place-items: center;
      outline: none;
      transform-origin: 50% 60%;
      transition: transform .15s ease;
    }
    .logo-float{
      display: inline-grid;
      place-items: center;
      animation: floaty 3.2s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100% { transform: translateY(0px); }
      50%     { transform: translateY(-10px); }
    }
    .logo-btn:hover{ transform: scale(1.06); }
    .logo-btn:active{ transform: scale(0.99); }

    .logo-sparkle{
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      pointer-events: none;
      background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,255,255,.2) 45%, rgba(255,255,255,0) 70%);
      filter: drop-shadow(0 0 10px rgba(255,255,255,.55));
      opacity: 0.0;
      animation: sparkle 1.6s ease-in-out infinite;
    }
    @keyframes sparkle{
      0%   { transform: scale(0.6); opacity: 0; }
      20%  { opacity: 1; }
      50%  { transform: scale(1.2); opacity: .9; }
      80%  { opacity: 0; }
      100% { transform: scale(0.7); opacity: 0; }
    }
    .logo-sparkle.sA{ left: 8%;  top: 22%; animation-delay: .0s; }
    .logo-sparkle.sB{ right: 10%; top: 34%; animation-delay: .4s; }
    .logo-sparkle.sC{ left: 22%; bottom: 18%; animation-delay: .8s; }
    .logo-sparkle.sD{ right: 22%; bottom: 12%; animation-delay: 1.2s; }

    main{
      width: 100%;
      max-width: 1100px;
      padding: 40px 16px 40px;
      display:grid;
      place-items: start center;
    }

    .card{
      width: min(720px, 92vw);
      padding: 20px 26px 26px;
      background: rgba(255,255,255,0.65);
      color: #111;
      border: none;
      border-radius: 0;
      box-shadow: 12px 12px 0 rgba(0,0,0,0.6);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{
      transform: translateY(-4px);
      box-shadow: 16px 16px 0 rgba(0,0,0,0.65);
    }
    .card h1{
      margin: 0 0 10px;
      font-size: clamp(24px, 3.5vw, 34px);
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: .05em;
    }
    .card p{
      margin: 0 0 16px;
      font-size: 15px;
      line-height: 1.6;
    }

    /* ===== Gästebuch UI ===== */
    .badge{
      display:inline-block;
      background:#fff;
      color:#111;
      font-weight: 900;
      letter-spacing: .08em;
      font-size: 12px;
      padding: 6px 10px;
      box-shadow: 6px 6px 0 #000;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .form{
      display:grid;
      gap: 12px;
      margin-top: 10px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 640px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-size: 12px;
      margin: 0 0 6px;
      color:#111;
    }

    input, textarea{
      width: 100%;
      padding: 10px 12px;
      border: 0;
      outline: none;
      background: rgba(255,255,255,0.85);
      color: #111;
      font-size: 14px;
      box-shadow: 8px 8px 0 rgba(0,0,0,0.55);
    }
    textarea{ resize: vertical; min-height: 110px; }

    .actions{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items:center;
      margin-top: 4px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:#fff;
      color:#111;
      text-decoration:none;
      padding: 10px 14px;
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-size: 12px;
      border: none;
      cursor: pointer;
      box-shadow: 8px 8px 0 #000;
      transition: transform .15s ease, box-shadow .15s ease;
      user-select: none;
    }
    .btn:hover{
      transform: translateY(-2px);
      box-shadow: 10px 10px 0 #000;
    }
    .btn:active{
      transform: translateY(1px);
      box-shadow: 6px 6px 0 #000;
    }

    .hint{
      font-size: 12px;
      opacity: .85;
      margin: 0;
      color:#111;
    }

    .entries{
      margin-top: 18px;
      display:grid;
      gap: 14px;
    }

    .entry{
      background: rgba(255,255,255,0.55);
      border: 0;
      box-shadow: 8px 8px 0 rgba(0,0,0,0.55);
      padding: 14px 16px;
    }

    .entry .top{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .entry .name{
      font-size: 14px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .04em;
      margin: 0;
      color:#111;
    }

    .entry .date{
      font-size: 12px;
      font-weight: 800;
      opacity: .75;
      color:#111;
    }

    .entry .msg{
      margin: 0;
      font-size: 14px;
      line-height: 1.55;
      white-space: pre-wrap;
      color:#111;
    }

    /* ===== SILHOUETTE ===== */
    .silhouette{
      position: fixed;
      right: 18px;
      bottom: 0;
      width: min(380px, 32vw);
      max-width: 520px;
      z-index: 20;
      cursor: pointer;
      filter: drop-shadow(0 22px 40px rgba(0,0,0,.35));
      user-select:none;
      transition: transform .12s ease;
      opacity: 0.85;
    }
    .silhouette img{
      width: 100%;
      height: auto;
      display:block;
      transition: opacity .22s ease, transform .22s ease;
      pointer-events:none;
      -webkit-user-drag:none;
    }
    .silhouette .hover{
      position:absolute;
      inset: 0;
      opacity: 0;
      transform: translateY(6px);
    }
    .silhouette:hover .base{ opacity: 0; transform: translateY(-4px); }
    .silhouette:hover .hover{ opacity: 1; transform: translateY(0); }
    .silhouette:active{ transform: scale(0.97); }

    @media (max-width: 820px){
      .silhouette{
        width: min(240px, 52vw);
        right: 10px;
        opacity: .95;
      }
    }

    /* ===== MJ TV ===== */
    .mj-tv{
      position: fixed;
      left: -45px;
      bottom: 0;
      width: min(460px, 32vw);
      z-index: 20;
      user-select: none;
      filter: drop-shadow(0 22px 40px rgba(0,0,0,.35));
    }

    .mj-tv .tv-wrap{ position: relative; width: 100%; }
    .mj-tv .tv-overlay{
      position: relative;
      z-index: 2;
      width: 100%;
      height: auto;
      display: block;
      pointer-events: none;
      -webkit-user-drag:none;
    }
    .mj-tv .tv-video{
      position: absolute;
      left: 57.8%;
      top: 35.2%;
      width: 30.5%;
      height: 20.8%;
      background: #000;
      object-fit: cover;
      border-radius: 22px;
      z-index: 1;
      pointer-events: none;
    }

    .mj-tv .tv-btn{
      position: absolute;
      z-index: 3;
      background: transparent;
      border: none;
      cursor: pointer;
      border-radius: 999px;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .mj-tv .tv-btn.pressed{
      transform: translateY(2px) scale(0.95);
      box-shadow: inset 0 2px 4px rgba(0,0,0,.6);
    }
    .mj-tv .tv-btn.b1{ left: 91.6248%; top: 37.6376%; width: 3.6293%; height: 2.9213%; }
    .mj-tv .tv-btn.b2{ left: 91.6248%; top: 41.2362%; width: 3.5176%; height: 3.0059%; }
    .mj-tv .tv-btn.b3{ left: 91.6248%; top: 44.9196%; width: 4.0201%; height: 3.0059%; }
    .mj-tv .tv-btn.b4{ left: 91.6248%; top: 48.3065%; width: 3.9643%; height: 3.0906%; }

    @media (max-width: 820px){
      .mj-tv{ width: min(320px, 55vw); left: 10px; }
    }

    /* Outfit sparkles */
    .mj-sparkles{
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 4;
      mix-blend-mode: screen;
      transform: translateY(-2cm);
    }
    .mj-glint{
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: radial-gradient(circle,
        rgba(255,255,255,1) 0%,
        rgba(255,255,255,.95) 18%,
        rgba(180,235,255,.75) 42%,
        rgba(255,255,255,0) 72%);
      opacity: 0;
      filter:
        drop-shadow(0 0 12px rgba(255,255,255,1))
        drop-shadow(0 0 26px rgba(170,235,255,.9));
      animation: mjSparkle 1.6s infinite ease-in-out;
      transform: translateZ(0);
    }
    .mj-glint::before,
    .mj-glint::after{
      content:"";
      position: absolute;
      left: 50%;
      top: 50%;
      width: 34px;
      height: 3px;
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.95), rgba(255,255,255,0));
      transform: translate(-50%,-50%);
      opacity: 0;
      filter: drop-shadow(0 0 10px rgba(255,255,255,1));
      animation: flareOpacity 1.6s infinite ease-in-out;
    }
    .mj-glint::after{ transform: translate(-50%,-50%) rotate(90deg); }

    @keyframes mjSparkle{
      0%   { transform: scale(.35) rotate(0deg); opacity: 0; }
      25%  { transform: scale(1.25) rotate(10deg); opacity: 1; }
      60%  { transform: scale(.85) rotate(-8deg); opacity: .25; }
      100% { transform: scale(.35) rotate(0deg); opacity: 0; }
    }
    @keyframes flareOpacity{
      0%,18%  { opacity: 0; }
      25%     { opacity: .95; }
      55%     { opacity: 0; }
      100%    { opacity: 0; }
    }

    .mj-glint.g1  { left: 18%; top: 54%; animation-delay: .05s; }
    .mj-glint.g2  { left: 22%; top: 60%; animation-delay: .30s; }
    .mj-glint.g3  { left: 20%; top: 66%; animation-delay: .55s; }
    .mj-glint.g4  { left: 26%; top: 58%; animation-delay: .80s; }
    .mj-glint.g5  { left: 28%; top: 63%; animation-delay: 1.05s; }
    .mj-glint.g6  { left: 24%; top: 70%; animation-delay: 1.25s; }
    .mj-glint.g7  { left: 30%; top: 69%; animation-delay: 1.45s; }
    .mj-glint.g8  { left: 16%; top: 62%; animation-delay: .95s; }
    .mj-glint.g9  { left: 14%; top: 68%; animation-delay: 1.15s; }
    .mj-glint.g10 { left: 32%; top: 60%; animation-delay: .18s; }
    .mj-glint.g11 { left: 34%; top: 66%; animation-delay: .42s; }
    .mj-glint.g12 { left: 36%; top: 72%; animation-delay: .70s; }
  </style>
</head>

<body>

  <!-- BACKGROUND -->
  <div class="stage" aria-hidden="true">
    <div class="glow"></div>
    <canvas id="sparkles"></canvas>
  </div>

  <!-- FIXED INTERACTIVE -->
  <div class="silhouette" title="Hover mich!">
    <img class="base" src="media/silhouette-black.png" alt="Silhouette">
    <img class="hover" src="media/silhouette-hover.png" alt="Silhouette Hover">
  </div>

  <div class="mj-tv">
    <div class="tv-wrap">
      <img src="media/TV.png" class="tv-overlay" alt="MJ und TV">

      <div class="mj-sparkles">
        <span class="mj-glint g1"></span><span class="mj-glint g2"></span><span class="mj-glint g3"></span>
        <span class="mj-glint g4"></span><span class="mj-glint g5"></span><span class="mj-glint g6"></span>
        <span class="mj-glint g7"></span><span class="mj-glint g8"></span><span class="mj-glint g9"></span>
        <span class="mj-glint g10"></span><span class="mj-glint g11"></span><span class="mj-glint g12"></span>
      </div>

      <video id="tvVideo" class="tv-video" playsinline preload="metadata" muted></video>

      <button class="tv-btn b1" type="button" data-video="media/tv1.mp4" aria-label="TV 1"></button>
      <button class="tv-btn b2" type="button" data-video="media/tv2.mp4" aria-label="TV 2"></button>
      <button class="tv-btn b3" type="button" data-video="media/tv3.mp4" aria-label="TV 3"></button>
      <button class="tv-btn b4" type="button" data-video="media/tv4.mp4" aria-label="TV 4"></button>
    </div>
  </div>

  <!-- AUDIO -->
  <audio id="logoSound" preload="auto">
    <source src="media/click1.mp3" type="audio/mpeg">
    <source src="media/click1.wav" type="audio/wav">
  </audio>
  <audio id="silhouetteSound" preload="auto">
    <source src="media/click2.mp3" type="audio/mpeg">
    <source src="media/click2.wav" type="audio/wav">
  </audio>
  <audio id="tvClickSound" preload="auto">
    <source src="media/tvclick.mp3" type="audio/mpeg">
  </audio>

  <!-- CONTENT -->
  <div class="wrap" id="fitContent">

    <div class="logo-area">
      <div class="logo-float">
        <button class="logo-btn" id="logoBtn" aria-label="Logo">
          <img class="logo" src="media/logo.png" alt="Logo">
          <span class="logo-sparkle sA"></span>
          <span class="logo-sparkle sB"></span>
          <span class="logo-sparkle sC"></span>
          <span class="logo-sparkle sD"></span>
        </button>
      </div>
    </div>

    <header>
      <nav aria-label="Hauptmenü" class="menu">
        <a class="sticker s1" href="home.html"><span>HOME</span></a>
        <a class="sticker s2" href="ueber-uns.html"><span>ÜBER UNS</span></a>
        <a class="sticker s3" href="episoden.html"><span>EPISODEN</span></a>
        <a class="sticker s4" href="gaestebuch.html"><span>GÄSTEBUCH</span></a>
        <a class="sticker s5" href="kontakt.html"><span>KONTAKT</span></a>
      </nav>
    </header>

    <main>
      <section class="card">
        <h1>GÄSTEBUCH</h1>
        <p>Schreib uns eine Nachricht. Bitte bleib freundlich ✨</p>

        <div id="status" class="badge">LÄDT…</div>

        <form id="guestForm" class="form" autocomplete="off">
          <div class="row">
            <div>
              <label for="name">Name</label>
              <input id="name" name="name" maxlength="40" placeholder="Dein Name" required />
            </div>
            <div>
              <label for="city">Ort (optional)</label>
              <input id="city" name="city" maxlength="40" placeholder="z.B. Berlin" />
            </div>
          </div>

          <div>
            <label for="message">Nachricht</label>
            <textarea id="message" name="message" maxlength="600" placeholder="Deine Nachricht…" required></textarea>
          </div>

          <div class="actions">
            <button class="btn" type="submit">Eintragen</button>
            <p class="hint">Max. 600 Zeichen. Kein Login nötig.</p>
          </div>
        </form>

        <div class="entries" id="entries" aria-live="polite"></div>
      </section>
    </main>
  </div>

  <script>
    // ===== CANVAS SPARKLES =====
    const canvas = document.getElementById("sparkles");
    const ctx = canvas.getContext("2d", { alpha: true });

    let w, h, dpr;
    function resize(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      w = canvas.width = Math.floor(innerWidth * dpr);
      h = canvas.height = Math.floor(innerHeight * dpr);
    }
    addEventListener("resize", resize, { passive:true });
    resize();

    const rand = (a,b) => a + Math.random()*(b-a);

    const COUNT = 110;
    const stars = Array.from({length: COUNT}, () => ({
      x: rand(0, w),
      y: rand(0, h),
      r: rand(0.9, 2.4) * dpr,
      a: rand(0.10, 0.40),
      ph: rand(0, Math.PI*2),
      tw: rand(0.7, 1.8),
      vx: rand(-0.03, 0.03) * dpr,
      vy: rand(0.02, 0.08) * dpr
    }));

    function draw(t){
      ctx.clearRect(0,0,w,h);
      ctx.globalCompositeOperation = "lighter";

      for (const s of stars){
        s.x += s.vx; s.y += s.vy;
        if (s.x < -20*dpr) s.x = w + 20*dpr;
        if (s.x > w + 20*dpr) s.x = -20*dpr;
        if (s.y > h + 20*dpr) s.y = -20*dpr;

        const tw = (Math.sin((t*0.001)*s.tw + s.ph) * 0.5 + 0.5);
        const alpha = s.a * (0.35 + 0.65*tw);

        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r*(0.75 + tw*0.7), 0, Math.PI*2);
        ctx.fillStyle = `rgba(255,255,255,${alpha})`;
        ctx.fill();
      }

      ctx.globalCompositeOperation = "source-over";
      requestAnimationFrame(draw);
    }
    requestAnimationFrame(draw);

    // ===== SOUNDS / LOGO NAV =====
    const logoBtn = document.getElementById("logoBtn");
    const logoSound = document.getElementById("logoSound");
    if (logoBtn && logoSound){
      logoBtn.addEventListener("click", (e) => {
        e.preventDefault();
        try { logoSound.currentTime = 0; logoSound.play(); } catch(err){}
        setTimeout(() => { window.location.href = "home.html"; }, 1500);
      });
    }

    const silhouette = document.querySelector(".silhouette");
    const silhouetteSound = document.getElementById("silhouetteSound");
    if (silhouette && silhouetteSound){
      silhouette.addEventListener("click", () => {
        try { silhouetteSound.currentTime = 0; silhouetteSound.play(); } catch(err){}
      });
    }

    // ===== TV BUTTONS -> VIDEO PLAY + IDLE STATIC =====
    const tvVideo = document.getElementById("tvVideo");
    const tvButtons = document.querySelectorAll(".tv-btn");
    const tvClickSound = document.getElementById("tvClickSound");

    const IDLE_SRC = "media/tv-static.mp4";
    let activeSrc = IDLE_SRC;

    function playSrc(src, { loop=false, muted=false } = {}){
      if (!tvVideo) return;

      tvVideo.pause();
      tvVideo.src = src;
      tvVideo.currentTime = 0;
      tvVideo.loop = loop;
      tvVideo.muted = muted;

      const p = tvVideo.play();
      if (p && typeof p.catch === "function"){
        p.catch(() => {
          tvVideo.muted = true;
          tvVideo.play().catch(()=>{});
        });
      }
    }

    if (tvVideo){
      activeSrc = IDLE_SRC;
      playSrc(IDLE_SRC, { loop:true, muted:true });
    }

    tvButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const src = btn.getAttribute("data-video");
        if (!src) return;

        if (tvClickSound){
          try { tvClickSound.currentTime = 0; tvClickSound.play(); } catch(err){}
        }

        btn.classList.remove("pressed");
        void btn.offsetWidth;
        btn.classList.add("pressed");
        setTimeout(() => btn.classList.remove("pressed"), 120);

        if (activeSrc === src){
          activeSrc = IDLE_SRC;
          playSrc(IDLE_SRC, { loop:true, muted:true });
          return;
        }

        activeSrc = src;
        playSrc(src, { loop:false, muted:false });
      });
    });

    if (tvVideo){
      tvVideo.addEventListener("ended", () => {
        activeSrc = IDLE_SRC;
        playSrc(IDLE_SRC, { loop:true, muted:true });
      });
    }
  </script>

  <!-- Firebase Guestbook (GitHub Pages friendly) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, onSnapshot, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBue0LgkcuYoq9vgz_JyMeLwfD9E2OQJ-U",
      authDomain: "dermjpodcast.firebaseapp.com",
      projectId: "dermjpodcast",
      storageBucket: "dermjpodcast.firebasestorage.app",
      messagingSenderId: "215082779399",
      appId: "1:215082779399:web:1961cde806a9f98b0f7ba2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const statusEl  = document.getElementById("status");
    const form      = document.getElementById("guestForm");
    const entriesEl = document.getElementById("entries");

    const guestRef = collection(db, "guestbook");

    function escapeHtml(s){
      return (s || "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function formatDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        if (!d) return "";
        return d.toLocaleDateString("de-DE", { year:"numeric", month:"2-digit", day:"2-digit" });
      } catch { return ""; }
    }

    function renderEntry(doc){
      const data = doc.data() || {};
      const name = escapeHtml(data.name || "Anonym");
      const city = escapeHtml(data.city || "");
      const msg  = escapeHtml(data.message || "");
      const date = formatDate(data.createdAt);

      const who = city ? `${name} · ${city}` : name;

      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <div class="top">
          <p class="name">${who}</p>
          <div class="date">${escapeHtml(date)}</div>
        </div>
        <p class="msg">${msg}</p>
      `;
      return div;
    }

    // Live-Liste (letzte 50)
    const q = query(guestRef, orderBy("createdAt", "desc"), limit(50));
    onSnapshot(q, (snap) => {
      entriesEl.innerHTML = "";
      snap.forEach((d) => entriesEl.appendChild(renderEntry(d)));
      statusEl.textContent = "BEREIT";
    }, (err) => {
      statusEl.textContent = "FEHLER";
      entriesEl.innerHTML = `<p class="hint">Firestore Fehler: ${escapeHtml(err.message)}</p>`;
    });

    // Submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = (document.getElementById("name").value || "").trim();
      const city = (document.getElementById("city").value || "").trim();
      const message = (document.getElementById("message").value || "").trim();

      if (!name || !message) return;

      statusEl.textContent = "SENDET…";

      try{
        await addDoc(guestRef, {
          name: name.slice(0, 40),
          city: city.slice(0, 40),
          message: message.slice(0, 600),
          createdAt: serverTimestamp()
        });

        form.reset();
        statusEl.textContent = "GESENDET ✓";
        setTimeout(() => (statusEl.textContent = "BEREIT"), 1200);
      } catch(err){
        statusEl.textContent = "FEHLER";
        alert("Konnte nicht senden: " + (err?.message || err));
      }
    });
  </script>
</body>
</html>